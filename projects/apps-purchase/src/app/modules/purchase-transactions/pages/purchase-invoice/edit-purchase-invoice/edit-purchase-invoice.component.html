<lib-page-content [title]="'PurchaseInvoiceEdit.TaxList' | translate" [subTitle]="'PurchaseInvoiceEdit.TaxList' | translate">

    <!-- <div [formGroup]="addForm" class="stockInForm_header card_micro">
      <div class="grid">
        <div class="md:col-2 my-2">
          <lib-label [appControl]="addForm.controls['code']">
            {{ 'PurchaseInvoiceEdit.code' | translate }}
          </lib-label>
          <lib-text-input [readOnly]="true" placeholder="{{ 'PurchaseInvoiceEdit.code' | translate }}"
            formControlName="code"></lib-text-input>
          <lib-field-validations [appControl]="addForm.controls['code']"></lib-field-validations>
        </div>
        <div class="md:col-2 my-2">
          <lib-label [appControl]="addForm.controls['receiptDate']">
            {{ 'PurchaseInvoiceEdit.date' | translate }}
          </lib-label>
          <lib-calendar formControlName="receiptDate"></lib-calendar>
          <lib-field-validations [appControl]="addForm.controls['receiptDate']"></lib-field-validations>
        </div>
  
        <div class="md:col-2 my-2">
          <lib-label [appControl]="addForm.controls['sourceDocumentType']">
            {{ 'PurchaseInvoiceEdit.docType' | translate }}
          </lib-label>
          <lib-select 
          formControlName="sourceDocumentType" 
          [options]="lookups[LookupEnum.StockInOutSourceDocumentType]"
            optionValue="name"
             optionLabel="name">
          </lib-select>
          <lib-field-validations [appControl]="addForm.controls['sourceDocumentType']"></lib-field-validations>
        </div>
        <div class="md:col-3 my-2">
          <lib-label [appControl]="addForm.controls['sourceDocumentId']">
            {{ 'PurchaseInvoiceEdit.sourceDoc' | translate }}
          </lib-label>
          <lib-select 
          formControlName="sourceDocumentId" 
          [options]="oprationalLookup"
          optionValue="id"
          optionLabel="displayName"
            placeholder="{{ 'PurchaseInvoiceEdit.sourceDoc' | translate }}"
            [selectedValue]="addForm.controls['sourceDocumentId'].value">
          </lib-select>
          <lib-field-validations [appControl]="addForm.controls['sourceDocumentId']"></lib-field-validations>
        </div>
        <div class="md:col-3 my-2">
          <lib-label [appControl]="addForm.controls['warehouseId']">
            {{ 'PurchaseInvoiceEdit.warehouse' | translate }}
          </lib-label>
         
          <lib-text-input
          formControlName="warehouseName"
          [readOnly]="true"
          >
  
          </lib-text-input>
          <lib-field-validations [appControl]="addForm.controls['warehouseId']"></lib-field-validations>
        </div>
        <div class="md:col-6 my-2">
          <div>
            <lib-label [appControl]="addForm.controls['notes']">
              {{ 'PurchaseInvoiceEdit.notes' | translate }}
            </lib-label>
          </div>
  
          <textarea pInputTextarea style="width: 100% ;max-width: 100%; height: auto; max-height: 150px;" rows="1" formControlName="notes"
            placeholder="{{ 'PurchaseInvoiceEdit.notes' | translate }}"></textarea>
        </div>
      </div>
    </div> -->

    <div class="main_header card_micro " [formGroup]="addForm">
        <div class="grid">
            <div class="col-12 md:col-4">
                <div class="card_information">
                    <div class="line">
                    </div>
                    <div class="item">
                        <div class="title heading_b18">
                            main information
                        </div>
                        <div class="item_body">
                            <div class="grid">
                                <div class="col-12 md:col-4">
                                    <lib-form-group>
                                        <lib-label [appControl]="addForm.controls['code']">
                                            invoice code
                                        </lib-label>
                                        <lib-text-input [readOnly]="true" formControlName="code">

                                        </lib-text-input>
                                    </lib-form-group>
                                </div>
                                <div class="col-12 md:col-8">
                                    <lib-form-group>
                                        <lib-label [appControl]="addForm.controls['code']">
                                            invoice Date
                                        </lib-label>
                                        <lib-calendar></lib-calendar>
                                    </lib-form-group>
                                </div>
                                <div class="col-12 ">
                                    <lib-form-group>
                                        <lib-label [appControl]="addForm.controls['code']">
                                            invoice description
                                        </lib-label>

                                        <lib-text-input [readOnly]="true" formControlName="code">

                                        </lib-text-input> </lib-form-group>
                                </div>
                                <div class="col-12 ">
                                    <lib-form-group>
                                        <lib-label [appControl]="addForm.controls['code']">
                                            warehouse
                                        </lib-label>
                                        <lib-select  formControlName="code">

                                        </lib-select> </lib-form-group>
                                </div>
                            </div>

                        </div>
                    </div>
                </div>
            </div>
            <div class="col-12 md:col-4">
                <div class="card_information">
                    <div class="line">
                    </div>
                    <div class="item">
                        <div class="title heading_b18">
                            related operation </div>
                            <div class="item_body">
                                <div class="grid">
                                    <div class="col-12 md:col-6">
                                        <lib-form-group>
                                            <lib-label [appControl]="addForm.controls['code']">
                                                vendor code                                             </lib-label>
                                                <div class="flex gap-2 align-items-center">
                                                    <lib-select 
                                                    formControlName="code"
                                                     [options]="vendorItems"
                                                     optionValue="id" 
                                                        optionLabel="name"
                                                        [customClass]="'add-journal'"
                                                    
                                                        (valueSearchChanged)="onFilterVendor($event )"></lib-select>
                                                    <i class="pi pi-search search-circle"  ></i>
                                                </div>

                                        </lib-form-group>
                                    </div>
                                    <div class="col-12 md:col-6">
                                        <lib-form-group>
                                            <lib-label [appControl]="addForm.controls['code']">
                                                vendor name                                            </lib-label>
                                                <lib-text-input  formControlName="code"> </lib-text-input>
                                                </lib-form-group>
                                    </div>
                                    <div class="col-12 md:col-3 ">
                                        <lib-form-group>
                                            <lib-label [appControl]="addForm.controls['code']">
                                                currency                                            </lib-label>
    
                                            <lib-text-input [readOnly]="true" formControlName="code">
    
                                            </lib-text-input> </lib-form-group>

                                    </div>
                                    <div class="col-12 md:col-6 ">
                                        <lib-form-group>
                                            <lib-label [appControl]="addForm.controls['code']">
                                                rate                                            </lib-label>
                                                <lib-text-input  formControlName="code">
    
                                          </lib-text-input>   </lib-form-group>
                                    </div>
                                    <div class="col-12 md:col-6 ">
                                        <lib-form-group>
                                            <lib-label [appControl]="addForm.controls['code']">
                                                payment terms                                            </lib-label>
                                            <lib-select  formControlName="code">
    
                                            </lib-select> </lib-form-group>
                                    </div>
                                    <div class="col-12 md:col-6 ">
                                        <lib-form-group>
                                            <lib-label [appControl]="addForm.controls['code']">
                                                reference                                            </lib-label>
                                            <lib-text-input  formControlName="code">
    
                                            </lib-text-input> </lib-form-group>
                                    </div>
                                </div>
    
                            </div>
                    </div>
                </div>
            </div>
            <div class="col-12 md:col-4">
                <div class="card_information">
                    <div class="line">
                    </div>
                    <div class="item">
                        <div class="title heading_b18">
                            main information
                        </div>
                        <div class="item_body">
                            <div class="grid">
                                <div class="col-12 md:col-8 ">
                                    <lib-form-group>
                                        <lib-label [appControl]="addForm.controls['code']">
                                            invoice journal                                           </lib-label>
                                        <lib-text-input formControlName="code">

                                        </lib-text-input> </lib-form-group>
                                </div>
                                <div class="col-12  md:col-8  ">
                                    <lib-form-group>
                                        <lib-label [appControl]="addForm.controls['code']">
                                            stock out                                            </lib-label>
                                        <lib-text-input  formControlName="code">

                                        </lib-text-input> </lib-form-group>
                                </div>
                            </div>

                        </div>
                    </div>
                </div>
            </div>
        </div>

    </div>
    <div class="my-2 card_micro">
        <p-table [value]="stockOutDetailsFormArray.controls" dataKey="id"
            styleClass="p-datatable-gridlines p-datatable-striped" [tableStyle]="{ 'min-width': '50rem' }">
            <ng-template pTemplate="header">
                <tr>
                    <th>{{ 'PurchaseInvoiceEdit.barcode' | translate }}</th>
                    <th>{{ 'PurchaseInvoiceEdit.itemCode' | translate }}</th>
                    <th>{{ 'PurchaseInvoiceEdit.itemDescription' | translate }}</th>
                    <th>{{ 'PurchaseInvoiceEdit.UOM' | translate }}</th>
                    <th>{{ 'PurchaseInvoiceEdit.QTY' | translate }}</th>
                    <th>{{ 'PurchaseInvoiceEdit.cost' | translate }}</th>
                    <th>{{ 'PurchaseInvoiceEdit.subTotal' | translate }}</th>
                    <th>{{ 'PurchaseInvoiceEdit.discount' | translate }}</th>
                    <th>{{ 'PurchaseInvoiceEdit.discountAmt' | translate }}</th>
                    <th>{{ 'PurchaseInvoiceEdit.netCost' | translate }}</th>
                    <th>{{ 'PurchaseInvoiceEdit.totalAfter' | translate }}</th>
                    <th>{{ 'PurchaseInvoiceEdit.vat' | translate }}</th>
                    <th>{{ 'PurchaseInvoiceEdit.VatAmount' | translate }}</th>
                    <th>{{ 'PurchaseInvoiceEdit.grandTotal' | translate }}</th>
                    <th>{{ 'PurchaseInvoiceEdit.tracking' | translate }}</th>
                    <th>{{ 'PurchaseInvoiceEdit.actions' | translate }}</th>
                </tr>
            </ng-template>
            <ng-template pTemplate="body" let-stockOutFormGroup let-editing="editing" let-rowIndex="rowIndex">
                <tr [formGroup]="stockOutFormGroup">
                    <td [pEditableColumn]="stockOutFormGroup.controls['barCode']" pEditableColumnField="barCode">
                        <p-cellEditor>
                            <ng-template pTemplate="input">
                                <lib-text-input placeholder="{{ 'PurchaseInvoiceEdit.barcode' | translate }}"
                                    formControlName="barCode"
                                    (keydown.enter)="barcodeCanged($event, rowIndex)"></lib-text-input>
                            </ng-template>
                            <ng-template pTemplate="output">
                                {{ stockOutFormGroup.controls['barCode']?.value }}
                            </ng-template>
                        </p-cellEditor>
                        <lib-field-validations
                            [appControl]="stockOutFormGroup.controls['barCode']"></lib-field-validations>
                    </td>

                    <td [pEditableColumn]="stockOutFormGroup.controls['itemId']" pEditableColumnField="itemId">
                        <p-cellEditor>
                            <ng-template pTemplate="input">
                                <div class="flex gap-2 align-items-center">
                                    <lib-select formControlName="itemNumber" [options]="filteredItems"
                                        optionValue="itemNumber" optionLabel="displayName" [customClass]="'add-journal'"
                                        (valueChanged)="setRowData(rowIndex, $event ,filteredItems)"
                                        selectedValue="{{stockOutFormGroup.controls['itemNumber']?.value}}"
                                        (valueSearchChanged)="onFilter($event )"></lib-select>
                                    <i class="pi pi-search search-circle" (click)="openDialog(rowIndex)"></i>
                                </div>
                            </ng-template>
                            <ng-template pTemplate="output">
                                {{ stockOutFormGroup.get('itemName').value }}
                            </ng-template>
                        </p-cellEditor>
                        <lib-field-validations
                            [appControl]="stockOutFormGroup.controls['itemId']"></lib-field-validations>
                    </td>
                    <td [pEditableColumn]="stockOutFormGroup.controls['description']"
                        pEditableColumnField="description">
                        <p-cellEditor>
                            <ng-template pTemplate="input">
                                <lib-text-input placeholder="{{ 'PurchaseInvoiceEdit.itemDescription' | translate }}"
                                    formControlName="description"></lib-text-input>
                            </ng-template>
                            <ng-template pTemplate="output">
                                {{ stockOutFormGroup.controls['description']?.value }}
                            </ng-template>
                        </p-cellEditor>
                        <lib-field-validations
                            [appControl]="stockOutFormGroup.controls['description']"></lib-field-validations>
                    </td>

                    <td [pEditableColumn]="stockOutFormGroup.controls['uomId']" pEditableColumnField="uomId"
                        [ngClass]=" {'error':rowIndex==rowDuplicate && stockOutFormGroup.controls['showSerial']?.value ==false && stockOutFormGroup.controls['showBatch']?.value ==false  }">
                        <p-cellEditor>
                            <ng-template pTemplate="input">

                                <lib-select placeholder="{{ 'PurchaseInvoiceEdit.UOM' | translate }}" formControlName="uomId"
                                    [options]="stockOutFormGroup.get('uomOptions')?.value || []"
                                    [optionLabel]="selectedLanguage === 'en' ? 'uomNameEn' : 'uomNameAr'"
                                    optionValue="uomId" (valueChanged)="setUomName(rowIndex ,stockOutFormGroup.get('uomOptions').value ) ; isDuplicate(rowIndex)
                   ">

                                </lib-select>
                                <!-- <lib-text-input placeholder="{{ 'PurchaseInvoiceEdit.UOM' | translate }}" formControlName="uomId"></lib-text-input> -->
                            </ng-template>
                            <ng-template pTemplate="output">
                                {{ stockOutFormGroup.controls['uomName']?.value }}
                            </ng-template>
                        </p-cellEditor>
                        <lib-field-validations
                            [appControl]="stockOutFormGroup.controls['uomId']"></lib-field-validations>
                    </td>

                    <td [pEditableColumn]="stockOutFormGroup.controls['quantity']" pEditableColumnField="quantity"
                        [ngClass]=" {'error':rowIndex==rowDuplicate && serialError==true && stockOutFormGroup.controls['showSerial']?.value ==true && stockOutFormGroup.controls['quantity']?.value>1}">
                        <p-cellEditor>
                            <ng-template pTemplate="input">
                                <lib-text-input type="number" placeholder="{{ 'PurchaseInvoiceEdit.QTY' | translate }}"
                                    formControlName="quantity"
                                    (keyUp)="setCostTotal(rowIndex)  ; isDuplicate(rowIndex)"
                                    (valueChanged)="setCostTotal(rowIndex) "
                                    
                                    ></lib-text-input>
                            </ng-template>
                            <ng-template pTemplate="output">
                                {{ stockOutFormGroup.controls['quantity']?.value }}
                            </ng-template>
                        </p-cellEditor>
                        <lib-field-validations
                            [appControl]="stockOutFormGroup.controls['quantity']"></lib-field-validations>
                    </td>

                    <td [pEditableColumn]="stockOutFormGroup.controls['cost']" pEditableColumnField="cost">
                        <p-cellEditor>
                            <ng-template pTemplate="input">
                                <lib-text-input placeholder="{{ 'PurchaseInvoiceEdit.cost' | translate }}"
                                    formControlName="cost" type="number" 
                                     (keyUp)="setCostTotal(rowIndex)"
                                     (valueChanged)="setCostTotal(rowIndex)"
                                    ></lib-text-input>
                            </ng-template>
                            <ng-template pTemplate="output">
                                {{ stockOutFormGroup.controls['cost']?.value }}
                            </ng-template>
                        </p-cellEditor>
                        <lib-field-validations
                            [appControl]="stockOutFormGroup.controls['cost']"></lib-field-validations>
                    </td>
                    <td>
                        {{ stockOutFormGroup.controls['subCost']?.value }}

                    </td>
                    <td [pEditableColumn]="stockOutFormGroup.controls['discount']" pEditableColumnField="discount">
                    <p-cellEditor>
                        <ng-template pTemplate="input">
                            <lib-text-input type="number" placeholder="{{ 'PurchaseInvoiceEdit.QTY' | translate }}"
                                formControlName="discount"
                                (keyUp)="setDiscountAmt(rowIndex)"
                                (valueChanged)="setDiscountAmt(rowIndex)"
                                
                                ></lib-text-input>
                        </ng-template>
                        <ng-template pTemplate="output">
                            {{ stockOutFormGroup.controls['discount']?.value |numberFormat}}
                        </ng-template>
                    </p-cellEditor>
                    <lib-field-validations
                        [appControl]="stockOutFormGroup.controls['discount']"></lib-field-validations>
                </td>
                    <td [pEditableColumn]="stockOutFormGroup.controls['discountAmt']" pEditableColumnField="discountAmt">
                    <p-cellEditor>
                        <ng-template pTemplate="input">
                            <lib-text-input type="number" placeholder="{{ 'PurchaseInvoiceEdit.QTY' | translate }}"
                                formControlName="discountAmt"
                                (keyUp)="setDiscount(rowIndex)"
                                (valueChanged)="setDiscount(rowIndex)"
                                
                                
                                ></lib-text-input>
                        </ng-template>
                        <ng-template pTemplate="output">
                            {{ stockOutFormGroup.controls['discountAmt']?.value }}
                        </ng-template>
                    </p-cellEditor>
                    <lib-field-validations
                        [appControl]="stockOutFormGroup.controls['discountAmt']"></lib-field-validations>
                </td>
                <td>
                    {{ stockOutFormGroup.controls['netCost']?.value }}
                </td>
 

                  
                    <td>
                        {{ stockOutFormGroup.controls['totalAfter']?.value }}

                    </td>
                    <td>
                        {{ stockOutFormGroup.controls['vat']?.value }}

                    </td>
                    <td>
                        {{ stockOutFormGroup.controls['vat']?.value * stockOutFormGroup.controls['totalAfter']?.value }}

                    </td>
                    <td >
                        {{ ( stockOutFormGroup.controls['vat']?.value * stockOutFormGroup.controls['totalAfter']?.value)+ stockOutFormGroup.controls['totalAfter']?.value }}

                    </td>
                    <td>
                       
                    </td>
                    <td>
                       <lib-button-micro 
                       
                       nameClass="table_button_delete"
                       >

                       </lib-button-micro>
                    </td>
                  
                 
                </tr>
            </ng-template>
        </p-table>
        <div class="add_new  flex justify-content-start">
            <lib-button (onClick)="addNewRow()" className="outline-primary">
                {{ 'PurchaseInvoiceEdit.AddNewLine' | translate }}
            </lib-button>
        </div>
    </div>

    <div class="grid">
        <div class="md:col-12 my-3 grid flex justify-content-end">
            <div class="md:col-6 grid flex justify-content-end">
                <div class="md:col-4">
                    <lib-button-micro title="{{ 'Cancel' | translate }}" nameClass="cancel" widthNumber="100%"
                        (click)="onCancel()">
                    </lib-button-micro>
                </div>
                <div class="md:col-4">
                    <lib-button-micro title="{{ 'Save' | translate }}" nameClass="disabled" widthNumber="100%"
                        *ngIf="showPost">
                    </lib-button-micro>
                    <lib-button-micro title="{{ 'Save' | translate }}" nameClass="save" widthNumber="100%"
                        (click)="onSave()" *ngIf="!showPost">
                    </lib-button-micro>
                </div>
                <div class="md:col-4">
                    <lib-button-micro title="{{ 'Post' | translate }}" nameClass="disabled" widthNumber="100%"
                        *ngIf="!showPost">
                    </lib-button-micro>
                    <lib-button-micro title="{{ 'Post' | translate }}" nameClass="save" widthNumber="100%"
                        (click)="addToPost()" *ngIf="showPost">
                    </lib-button-micro>
                </div>
            </div>
        </div>
    </div>
</lib-page-content>