<lib-popup-page
  [save]="false"
  [showCancel]="false"
  title=" {{ 'workflow.Add_condition' | translate }}"
  [closeFunction]="onCancel"
>
  <div class="entry_table">
    <div class="card" style="margin-top: 0 !important">
      <p-table
        [value]="usersForm.controls"
        dataKey="id"
        styleClass="p-datatable-gridlines p-datatable-striped"
      >
        <ng-template pTemplate="header">
          <tr>
            <th>{{ 'workflow.andOr' | translate }}</th>
            <th>{{ 'workflow.variables' | translate }}</th>
            <th>{{ 'workflow.operators' | translate }}</th>
            <th>{{ 'workflow.value' | translate }}</th>
            <th>{{ 'workflow.actions' | translate }}</th>
          </tr>
        </ng-template>
        <ng-template pTemplate="body" let-usersForm let-i="rowIndex">
          <tr [formGroup]="usersForm">
            <!--  and Or-->
            <td [pEditableColumn]="usersForm.controls['andOr']" pEditableColumnField="andOr">
              <p-cellEditor>
                <ng-template pTemplate="input">
                  <!-- Disable the dropdown only for the first row (index 0) -->
                  <lib-select
                    *ngIf="i !== 0; else readOnly"
                    placeholder="{{ 'workflow.andOr' | translate }}"
                    [options]="andOR_List"
                    optionLabel="name"
                    optionValue="id"
                    formControlName="andOr"
                    [selectedValue]="usersForm.controls['andOr'].value"
                    (valueChanged)="selectedAndOR($event, usersForm, i)"
                  ></lib-select>
                  <!-- Read-only template for the first row -->
                  <ng-template #readOnly>
                    {{ usersForm.controls['andOrName'].value }}
                  </ng-template>
                </ng-template>
                <ng-template pTemplate="output">
                  {{ usersForm.controls['andOrName'].value }}
                </ng-template>
              </p-cellEditor>
              <lib-field-validations
                [appControl]="usersForm.controls['andOr']"
              ></lib-field-validations>
            </td>

            <!--  variables -->
            <td
              [pEditableColumn]="usersForm.controls['variables']"
              pEditableColumnField="variables"
            >
              <p-cellEditor>
                <ng-template pTemplate="input">
                  <lib-select
                    placeholder="{{ 'workflow.variables' | translate }}"
                    [options]="variableList"
                    optionLabel="name"
                    optionValue="name"
                    formControlName="variables"
                    [selectedValue]="usersForm.controls['variables'].value"
                  ></lib-select>
                  <!-- (valueChanged)="selectedVariable($event, usersForm, i)" -->
                </ng-template>
                <ng-template pTemplate="output">
                  {{ usersForm.controls['variables'].value }}
                </ng-template>
              </p-cellEditor>
              <lib-field-validations
                [appControl]="usersForm.controls['variables']"
              ></lib-field-validations>
            </td>

            <!--  operators -->
            <td
              [pEditableColumn]="usersForm.controls['operators']"
              pEditableColumnField="operators"
            >
              <p-cellEditor>
                <ng-template pTemplate="input">
                  <lib-select
                    placeholder="{{ 'workflow.operators' | translate }}"
                    [options]="operators_List"
                    optionLabel="name"
                    optionValue="id"
                    formControlName="operators"
                    [selectedValue]="usersForm.controls['operators'].value"
                  ></lib-select>
                </ng-template>
                <ng-template pTemplate="output">
                  {{ usersForm.controls['operators'].value }}
                </ng-template>
              </p-cellEditor>
              <lib-field-validations
                [appControl]="usersForm.controls['operators']"
              ></lib-field-validations>
            </td>

            <!-- value-->
            <td [pEditableColumn]="usersForm.controls['value']" pEditableColumnField="value">
              <p-cellEditor>
                <ng-template pTemplate="input">
                  <lib-text-input
                    type="text"
                    placeholder="{{ 'workflow.value' | translate }}"
                    formControlName="value"
                  ></lib-text-input>
                </ng-template>
                <ng-template pTemplate="output">
                  {{ usersForm.controls['value'].value }}
                </ng-template>
              </p-cellEditor>
              <lib-field-validations
                [appControl]="usersForm.controls['value']"
              ></lib-field-validations>
            </td>
            <td>
              <div class="actions flex align-items-center">
                <lib-button-micro
                  nameClass="table_button_delete"
                  type="button"
                  (click)="deleteLine(i)"
                >
                </lib-button-micro>
              </div>
            </td>
          </tr>
        </ng-template>
      </p-table>
      <div class="btn_group">
        <div class="grid mt-2">
          <div class="md:col-12">
            <div class="grid">
              <div class="md:col-3">
                <lib-button-micro
                  nameClass="cancel"
                  title="{{ 'workflow.cancel' | translate }}"
                  (click)="onCancel()"
                >
                </lib-button-micro>
              </div>
              <div class="md:col-3">
                <lib-button-micro
                  nameClass="save"
                  title="{{ 'workflow.add_condition' | translate }}"
                  (click)="addLine()"
                >
                </lib-button-micro>
              </div>
              <div class="md:col-3">
                <lib-button-micro
                  nameClass="save"
                  title="{{ 'workflow.save' | translate }}"
                  (click)="onSave(usersForm.value)"
                >
                </lib-button-micro>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</lib-popup-page>
